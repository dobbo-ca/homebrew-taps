name: Update Formulas

on:
  repository_dispatch:
    types: [update-formula]

permissions:
  contents: write

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GH_APP_CLIENT_ID }}
          private-key: ${{ secrets.GH_APP_PEM }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}

      - name: Update formula
        run: |
          FORMULA="${{ github.event.client_payload.formula }}"
          VERSION="${{ github.event.client_payload.version }}"
          FORMULA_FILE="Formula/${FORMULA}.rb"

          DARWIN_ARM64_SHA="${{ github.event.client_payload.darwin_arm64_sha }}"
          DARWIN_AMD64_SHA="${{ github.event.client_payload.darwin_amd64_sha }}"
          LINUX_ARM64_SHA="${{ github.event.client_payload.linux_arm64_sha }}"
          LINUX_AMD64_SHA="${{ github.event.client_payload.linux_amd64_sha }}"

          echo "Updating ${FORMULA} formula to version: ${VERSION}"
          echo "Darwin ARM64 SHA256: ${DARWIN_ARM64_SHA}"
          echo "Darwin AMD64 SHA256: ${DARWIN_AMD64_SHA}"
          echo "Linux ARM64 SHA256: ${LINUX_ARM64_SHA}"
          echo "Linux AMD64 SHA256: ${LINUX_AMD64_SHA}"

          if [ ! -f "$FORMULA_FILE" ]; then
            echo "Error: Formula file ${FORMULA_FILE} not found"
            exit 1
          fi

          # Update version
          sed -i "s|version \".*\"|version \"${VERSION}\"|" "$FORMULA_FILE"

          # Update URLs - pattern: formula-v1.0.0-darwin-arm64.tar.gz (with v prefix in filename)
          sed -i "s|${FORMULA}-v\?[0-9.]*-darwin-arm64.tar.gz|${FORMULA}-${VERSION}-darwin-arm64.tar.gz|g" "$FORMULA_FILE"
          sed -i "s|${FORMULA}-v\?[0-9.]*-darwin-amd64.tar.gz|${FORMULA}-${VERSION}-darwin-amd64.tar.gz|g" "$FORMULA_FILE"
          sed -i "s|${FORMULA}-v\?[0-9.]*-linux-arm64.tar.gz|${FORMULA}-${VERSION}-linux-arm64.tar.gz|g" "$FORMULA_FILE"
          sed -i "s|${FORMULA}-v\?[0-9.]*-linux-amd64.tar.gz|${FORMULA}-${VERSION}-linux-amd64.tar.gz|g" "$FORMULA_FILE"

          # Update release version in URLs (download path)
          sed -i "s|/download/v\?[0-9.]*[0-9]/|/download/${VERSION}/|g" "$FORMULA_FILE"

          # Update SHA256s for each platform
          sed -i "/darwin-arm64.tar.gz/,/sha256/ s/sha256 \".*\"/sha256 \"${DARWIN_ARM64_SHA}\"/" "$FORMULA_FILE"
          sed -i "/darwin-amd64.tar.gz/,/sha256/ s/sha256 \".*\"/sha256 \"${DARWIN_AMD64_SHA}\"/" "$FORMULA_FILE"
          sed -i "/linux-arm64.tar.gz/,/sha256/ s/sha256 \".*\"/sha256 \"${LINUX_ARM64_SHA}\"/" "$FORMULA_FILE"
          sed -i "/linux-amd64.tar.gz/,/sha256/ s/sha256 \".*\"/sha256 \"${LINUX_AMD64_SHA}\"/" "$FORMULA_FILE"

          echo "Updated formula:"
          cat "$FORMULA_FILE"

      - name: Commit and push
        run: |
          FORMULA="${{ github.event.client_payload.formula }}"
          VERSION="${{ github.event.client_payload.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet "Formula/${FORMULA}.rb"; then
            echo "No changes to formula file"
            exit 0
          fi

          git add "Formula/${FORMULA}.rb"
          git commit -m "chore: update ${FORMULA} to ${VERSION}"
          git push